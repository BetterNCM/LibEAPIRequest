(()=>{var _=Object.defineProperty;var U=(e,n)=>{for(var t in n)_(e,t,{get:n[t],enumerable:!0})};var A={};U(A,{NCM_IMAGE_CDNS:()=>x,PlayState:()=>S,checkEapiRequestFuncName:()=>l,classname:()=>H,eapiRequest:()=>c,genAudioPlayerCommand:()=>Q,genBitmapImage:()=>Z,getListenTogetherStatus:()=>K,getLyric:()=>z,getLyricCorrection:()=>J,getMusicURL:()=>W,getNCMImageUrl:()=>k,getPlayingSong:()=>w,getSongDetail:()=>B,settingPrefix:()=>j,tryFindEapiRequestFuncName:()=>u});var s=new EventTarget;function I(e,n){let t=0;return function(){let i=this,o=arguments;t&&clearTimeout(t),t=setTimeout(e.bind(i,o),n)}}function L(e){let n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",t=[];for(let r=0;r<e;r++)t.push(n.charAt(Math.floor(Math.random()*n.length)));return t.join("")}var d=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope;var $=()=>{};var p=$,P=d?(...e)=>console.warn("[AMLL-Worker]",...e):console.warn;var v="LibEAPIRequest";var N=`config.betterncm.${"plugin"in globalThis?plugin?.manifest?.slug||plugin?.manifest?.name||v:v}`,b=V();function V(){if(d)return{};try{return JSON.parse(localStorage.getItem(N)||"{}")}catch(e){return P("警告：AMLL 插件配置读取失败",e),{}}}var G=I(function(){if(d){s.dispatchEvent(new Event("config-saved"));return}try{localStorage.setItem(N,JSON.stringify(b))}catch(n){P("警告：AMLL 插件配置保存失败",n)}s.dispatchEvent(new Event("config-saved"))},2e3);function y(e,n){n===void 0?delete b[e]:b[e]=n,G()}function g(e,n){return b[e]===void 0?n:b[e]}var E=new Map,j="LibEAPIRequest:",S=(t=>(t[t.Playing=1]="Playing",t[t.Pausing=2]="Pausing",t))(S||{}),x=["https://p3.music.126.net/","https://p4.music.126.net/"],C=0;function k(e){return C++,C%=x.length,`${x[C]}${channel.encryptId(e.toString())}/${e}.jpg`}function c(e,n){return T(l(),[e,n])}function l(){let e=g("eapiRequestFuncName","");return p("加密请求函数",e),g("ncmPackageVersion","")!==APP_CONF.packageVersion&&(e="",y("ncmPackageVersion",APP_CONF.packageVersion)),e===""&&(e=u()||"",e===""&&(e=u(!0)||""),y("eapiRequestFuncName",e),s.dispatchEvent(new Event("config-changed-eapiRequestFuncName"))),e}try{l()}catch{}function B(...e){return new Promise((n,t)=>{c(`${APP_CONF.domain}/api/v3/song/detail`,{type:"json",data:{c:JSON.stringify(e.map(r=>({id:r})))},onload:n,onerror:t})})}function K(){return new Promise((e,n)=>{c(`${APP_CONF.domain}/api/listen/together/status/get`,{type:"json",onload:e,onerror:n})})}function u(e=!1){let n=["_bindTokenRequest","yidun","getToken","undefined"],t=["/api","register","anonimous"],r=betterncm.ncm.findApiFunction(i=>(i.toString().includes(n.join(" "))||i.toString().includes(t.join("/")))&&i!==u);if(r){for(let i in r[1])if(r[1][i]===r[0]){p("查找到原始请求函数：",i,r);let o=i;if(e)return o;for(let a in r[1])if(r[1][a]?.originalFunc?.toString()?.includes(`.${o}(`))return p("查找到绑定请求函数：",a,r),a}}return p("查找请求函数失败"),null}function T(e,n){if(!E.has(e)){let r=betterncm.ncm.findApiFunction(e);if(r){let[i,o]=r;E.set(e,i.bind(o))}}let t=E.get(e);if(t)return t.apply(null,n);throw new TypeError(`函数 ${e} 未找到`)}function z(e){return new Promise((n,t)=>{c(`${APP_CONF.domain}/api/song/lyric/v1`,{type:"json",query:{id:e,cp:!1,tv:0,lv:0,rv:0,kv:0,yv:0,ytv:0,yrv:0},onload:n,onerror:t})})}function W(e,n=999e3){return new Promise((t,r)=>{c(`${APP_CONF.domain}/api/song/enhance/download/url`,{method:"POST",type:"json",data:{id:e,br:n},onload:t,onerror:r})})}function J(e){return new Promise((n,t)=>{c(`${APP_CONF.domain}/api/song/web/lyric/correction`,{type:"json",query:{id:e},onload:n,onerror:t})})}function w(){return T("getPlaying",[])}function Q(e,n){return`${e}|${n}|${L(6)}`}function H(...e){let n=[];for(let t of e)if(typeof t=="string"){let r=t.trim();n.includes(r)||n.push(r)}else for(let r in t)if(t[r]){let i=r.trim();n.includes(i)||n.push(i)}return n.join(" ")}async function Z(e){let n=new Image;n.src=e,await n.decode();let t=new OffscreenCanvas(n.width,n.height),r=t.getContext("2d");if(r)return r.drawImage(n,0,0),t.transferToImageBitmap()}function R(e,n){let[t,r]=React.useState(g(e,n)||n),i=React.useMemo(()=>`config-changed-${e}`,[e]);return React.useEffect(()=>{y(e,t),s.dispatchEvent(new Event(i))},[t]),React.useEffect(()=>{let o=()=>{let a=g(e,n)||n;r(a)};return s.addEventListener(i,o),()=>{s.removeEventListener(i,o)}},[e,n,i]),[t,r]}var O=e=>{let[n,t]=R(e.settingKey,e.defaultValue),{onChange:r,settingKey:i,defaultValue:o,...a}=e;return h("input",{type:"text",style:{margin:"8px 0"},value:n,onChange:m=>t(m.currentTarget.value),...a})};var M=()=>{let e=React.useMemo(()=>APP_CONF.packageVersion,[]),[n,t]=R("eapiRequestFuncName",""),r=React.useMemo(()=>{if(n!==""){let i=betterncm.ncm.findApiFunction(n);return i===null?"":"originalFunc"in i[0]?i[0].originalFunc.toString():i.toString()}else return""},[n]);return h(f,null,h("h2",null,"网易云请求函数来源设置"),h("div",{style:{margin:"6px 0"}},"如果依赖此插件的其他插件无法正确使用，有可能是无法获取网易云请求函数，或者找到的函数并不是网易云请求函数，请确认此处的函数名称是对应你所使用的网易云版本的请求函数。"),h("div",{style:{margin:"6px 0"}},"具体可以前往插件 Github 仓库查询或在 BetterNCM 讨论群内询问作者 SteveXMH。"),h("div",{style:{margin:"6px 0"}},"当前网易云 core.js 版本：",e),h(O,{label:"网易云请求函数名称",settingKey:"eapiRequestFuncName",defaultValue:n}),h("div",{style:{margin:"6px 0"}},r===""?"无法找到该函数，歌词将无法工作":"已找到函数，请自行确定是否是网易云请求函数："),r.length>0?h("code",{style:{margin:"8px 0"}},r):h(f,null),h("div",{style:{margin:"8px 0"}},h("button",{onClick:()=>{let i=u();t(i||"")}},"尝试搜索请求函数（方式一）"),h("button",{onClick:()=>{let i=u(!0);t(i||"")}},"尝试搜索请求函数（方式二）")))};plugin.onLoad(function(){let e=this.mainPlugin;e.isRequestAvailable=()=>l()!=="",e.getRequestFnName=()=>l(),e.eapiRequest=c.bind(A);try{l()}catch{}if(!1)try{}catch{}});plugin.onConfig(()=>{let e=document.createElement("div");return e.style.height="100%",ReactDOM.render(h(M,null),e),e});})();
